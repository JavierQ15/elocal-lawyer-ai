x-pipeline-common: &pipeline-common
  build:
    context: .
    dockerfile: docker/Dockerfile.pipeline
  profiles: ["pipeline"]
  env_file:
    - .env
  environment:
    WORKSPACE_ROOT: /repo
    REDIS_URL: ${REDIS_URL:-redis://redis:6379}
    MONGO_URL: ${MONGO_URL:-mongodb://mongodb:27017/boe}
    MONGO_URI: ${MONGO_URI:-mongodb://mongodb:27017}
    MONGO_DB: ${MONGO_DB:-boe}
    QDRANT_URL: ${QDRANT_URL:-http://qdrant:6333}
    QDRANT_COLLECTION: ${QDRANT_COLLECTION:-boe_chunks}
    LOCAL_EMBEDDINGS_URL: ${LOCAL_EMBEDDINGS_URL:-http://ollama:11434/api/embeddings}
  depends_on:
    - mongodb
    - redis
    - qdrant
    - ollama
  volumes:
    - ./data:/repo/data

services:
  mongodb:
    image: mongo:8.0
    restart: unless-stopped
    environment:
      MONGO_INITDB_DATABASE: boe
    volumes:
      - mongo_data:/data/db
    ports:
      - "27017:27017"

  redis:
    image: redis:7.4-alpine
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"

  qdrant:
    image: qdrant/qdrant:v1.16.2
    restart: unless-stopped
    volumes:
      - qdrant_data:/qdrant/storage
    ports:
      - "6333:6333"

  ollama:
    image: ollama/ollama:latest
    restart: unless-stopped
    volumes:
      - ollama_data:/root/.ollama
    ports:
      - "11434:11434"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "ollama", "list"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  rag-api:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
    env_file:
      - .env
    environment:
      HOST: 0.0.0.0
      PORT: 3000
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}
      MONGO_URL: ${MONGO_URL:-mongodb://mongodb:27017/boe}
      QDRANT_URL: ${QDRANT_URL:-http://qdrant:6333}
      QDRANT_COLLECTION: ${QDRANT_COLLECTION:-boe_chunks}
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:5173,http://127.0.0.1:5173}
      RAG_LLM_BASE_URL: ${RAG_LLM_BASE_URL:-http://ollama:11434}
      RAG_LLM_MODEL: ${RAG_LLM_MODEL:-qwen2.5:7b-instruct}
      RAG_ANSWER_TOP_UNIDADES: ${RAG_ANSWER_TOP_UNIDADES:-5}
      RAG_ANSWER_MAX_UNIDAD_CHARS: ${RAG_ANSWER_MAX_UNIDAD_CHARS:-6000}
    depends_on:
      - mongodb
      - redis
      - qdrant
      - ollama
    ports:
      - "3000:3000"
    restart: unless-stopped

  web-ui:
    build:
      context: .
      dockerfile: docker/Dockerfile.web-ui
      args:
        VITE_RAG_API_URL: ${VITE_RAG_API_URL:-http://localhost:3000}
    depends_on:
      - rag-api
    ports:
      - "5173:80"
    restart: unless-stopped

  worker-orchestrator:
    <<: *pipeline-common
    command: ["node", "packages/pipeline/dist/workers/worker-orchestrator.js"]

  worker-sync:
    <<: *pipeline-common
    command: ["node", "packages/pipeline/dist/workers/worker-sync.js"]

  worker-build:
    <<: *pipeline-common
    command: ["node", "packages/pipeline/dist/workers/worker-build.js"]

  worker-index:
    <<: *pipeline-common
    command: ["node", "packages/pipeline/dist/workers/worker-index.js"]

  scheduler-seeder:
    <<: *pipeline-common
    command: ["node", "packages/pipeline/dist/index.js", "backfill", "--wait"]

  bull-board:
    <<: *pipeline-common
    command: ["node", "packages/pipeline/dist/board.js"]
    ports:
      - "3100:3100"

  ingestor:
    build:
      context: .
      dockerfile: docker/Dockerfile.ingestor
    profiles: ["pipeline-legacy"]
    env_file:
      - .env
    environment:
      MONGO_URL: ${MONGO_URL:-mongodb://mongodb:27017/boe}
      MONGO_URI: ${MONGO_URI:-mongodb://mongodb:27017}
      MONGO_DB: ${MONGO_DB:-boe}
    depends_on:
      - mongodb
    volumes:
      - ./data:/app/data

  builder:
    build:
      context: .
      dockerfile: docker/Dockerfile.builder
    profiles: ["pipeline-legacy"]
    env_file:
      - .env
    environment:
      MONGO_URL: ${MONGO_URL:-mongodb://mongodb:27017/boe}
      MONGO_URI: ${MONGO_URI:-mongodb://mongodb:27017}
      MONGO_DB: ${MONGO_DB:-boe}
    depends_on:
      - mongodb
    volumes:
      - ./data:/app/data

  indexer:
    build:
      context: .
      dockerfile: docker/Dockerfile.indexer
    profiles: ["pipeline-legacy"]
    env_file:
      - .env
    environment:
      MONGO_URL: ${MONGO_URL:-mongodb://mongodb:27017/boe}
      MONGO_URI: ${MONGO_URI:-mongodb://mongodb:27017}
      MONGO_DB: ${MONGO_DB:-boe}
      QDRANT_URL: ${QDRANT_URL:-http://qdrant:6333}
      QDRANT_COLLECTION: ${QDRANT_COLLECTION:-boe_chunks}
      LOCAL_EMBEDDINGS_URL: ${LOCAL_EMBEDDINGS_URL:-http://ollama:11434/api/embeddings}
    depends_on:
      - mongodb
      - qdrant
      - ollama
    volumes:
      - ./data:/app/data

volumes:
  mongo_data:
  redis_data:
  qdrant_data:
  ollama_data:
